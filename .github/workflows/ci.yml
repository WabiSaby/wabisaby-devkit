# WabiSaby DevKit - CI
# Runs on push and pull_request for the app (Go backend + frontend).
# Submodules (projects/*) are not checked out; run make test/lint/format-check locally
# with submodules, or configure a PAT with repo scope and submodules: recursive if needed.

name: CI

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

env:
  GO_VERSION: "1.22"

jobs:
  go-app:
    name: Go (app)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: app/go.sum

      - name: Set up Node (for frontend embed)
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "npm"
          cache-dependency-path: app/frontend/package-lock.json

      - name: Build frontend (required for go:embed)
        run: npm ci && npm run build
        working-directory: app/frontend

      - name: Build
        run: go build ./...
        working-directory: app

      - name: Test
        run: go test ./...
        working-directory: app

      - name: Format check
        run: |
          unformatted=$(gofmt -l .)
          if [ -n "$unformatted" ]; then
            echo "The following files need 'go fmt':"
            echo "$unformatted"
            exit 1
          fi
        working-directory: app

  frontend:
    name: Frontend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"
          cache: "npm"
          cache-dependency-path: app/frontend/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: app/frontend

      - name: Lint
        run: npm run lint
        working-directory: app/frontend

      - name: Build
        run: npm run build
        working-directory: app/frontend
